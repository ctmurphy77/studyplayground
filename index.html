<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <title>Times Tables</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {

    game.load.image('bg', 'assets/BG/BG.png');
    game.load.image('ground', 'assets/Tiles/2.png');
    game.load.image('water', 'assets/Tiles/18.png');
    game.load.image('water_surf', 'assets/Tiles/17.png');
    //game.load.image('pf_right', 'assets/Tiles/15.png');
    game.load.image('stage', 'assets/Tiles/stage1.png');
    game.load.image('star', 'assets/star.png');
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);

    // Load number sprites.
    var numdir = 'assets/Numbers/'
    var numval = ''
    var numpath = ''
    for (step=0; step<145; step++)
    {
        numval = step.toString();
        numpath = numdir + numval + '.png'
        console.log(numval)
        game.load.image(numval, numpath);
    }


}

var player;
var platforms;
var grounds;
var cursors;

var numbers;
var score = 0;
var scoreText;
var equation;

var all_equations;
var lefthand;
var righthand;
var solution;

var timesTable;

function create() {

    // Set up times table dictionary
    tableRange = (1,12);
    timesTable = setupTimesTable(tableRange);

    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //  A simple background for our game
    game.add.sprite(0, 0, 'bg');

    //  The platforms group contains the ground and the 2 ledges we can jump on
    grounds = game.add.group();
    platforms = game.add.group();
    number_sprites = game.add.group();

    //  We will enable physics for any object that is created in this group
    platforms.enableBody = true;
    grounds.enableBody = true;
    number_sprites.enableBody = true;
    //numbersleft.enableBody = true;

    var ground;
    var offset;

    // Here we create the ground.
    for (step=0; step<13; step++)
    {
        offset = 64 * step
        ground = grounds.create(offset, game.world.height - 63, 'water_surf');
        //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
        ground.scale.setTo(0.5, 0.5);
        ground.body.immovable = true;

        ground = grounds.create(offset, game.world.height - 14, 'water');
        ground.scale.setTo(0.5, 0.5);

        //  This stops it from falling away when you jump on it
        ground.body.immovable = true;
    }

    //  Now let's create two ledges
    var ledge = platforms.create(64, 450, 'stage');
    ledge.scale.setTo(0.5, 0.5);
    ledge.body.immovable = true;
    ledge.body.allowGravity = false;

    ledge = platforms.create(336, 350, 'stage');
    ledge.scale.setTo(0.5, 0.5);
    ledge.body.immovable = true;
    ledge.body.allowGravity = false;

    ledge = platforms.create(608, 250, 'stage');
    ledge.scale.setTo(0.5, 0.5);
    ledge.body.immovable = true;
    ledge.body.allowGravity = false;

    platforms.setAll('body.velocity.y', -100);

    // The player and its settings
    player = game.add.sprite(384, 200, 'dude');

    //  We need to enable physics on the player
    game.physics.arcade.enable(player);

    //  Player physics properties. Give the little guy a slight bounce.
    player.body.gravity.y = 500;
    player.body.collideWorldBounds = true;

    //  Our two animations, walking left and right.
    player.animations.add('left', [0, 1, 2, 3], 10, true);
    player.animations.add('right', [5, 6, 7, 8], 10, true);

	//  Our controls.
    cursors = game.input.keyboard.createCursorKeys();

	/////////////////////////////////////


    // Set up initial equation
    lefthand = game.rnd.integerInRange(1, 12);
    righthand = game.rnd.integerInRange(1, 12);
    solution = (timesTable[lefthand-1][righthand-1]).toString();
    console.log("Current solution is: ", solution);

	choice_array = [solution];
	for (var i = 0; i < 5; i++)
	{
		var choice = game.rnd.integerInRange(1, 144);
		choice_array.push(choice.toString());
	}
    shuffleArray(choice_array);

    //  The score
    equationText = lefthand.toString() + ' x ' + righthand.toString() + ' = '
    scoreText = game.add.text(16, 16, equationText, { fontSize: '32px', fill: '#000' });
    scoreText.x = 400 - (scoreText.width / 2);


    // Numbers setup
	for (var i = 0; i < 6; i++)
	{
		var number_sprite = number_sprites.create(game.world.width + (i * game.world.width / 2), 125, choice_array[i]);
		number_sprite.scale.setTo(0.75, 0.75);
	    number_sprite.body.immovable = true;
	    number_sprite.body.allowGravity = false;
	}

    // Set numbers velocity
    number_sprites.setAll('body.velocity.x', -100);



	/////////////////////////////////////



}

function update() {
    platforms.forEach(wrapPlatform);
    number_sprites.forEach(wrapNumbers);
    //numbersleft.forEach(wrapNumbers);

    //  Collide the player with the platforms
    game.physics.arcade.collide(player, platforms);

    // Left-hand numbers
    game.physics.arcade.overlap(player, number_sprites, collectNumber, null, this);
    /*
    // Right-hand numbers
    game.physics.arcade.overlap(player, numbersleft, collectNumber, null, this);
    */

    //  Reset the players velocity (movement)
    player.body.velocity.x = 0;

    if (cursors.left.isDown)
    {
        //  Move to the left
        player.body.velocity.x = -150;

        player.animations.play('left');
    }
    else if (cursors.right.isDown)
    {
        //  Move to the right
        player.body.velocity.x = 150;

        player.animations.play('right');
    }
    else
    {
        //  Stand still
        player.animations.stop();

        player.frame = 4;
    }

    //  Allow the player to jump if they are touching the ground.
    if (cursors.up.isDown && player.body.touching.down)
    {
        player.body.velocity.y = -350;
    }

    if (game.physics.arcade.collide(player, grounds))
    {
        player.body.velocity.y = -600;
    }

}

function setupTimesTable(tableRange) {
    timesTable =
    [
    [ 1,2,3,4,5,6,7,8,9,10,11,12 ],
    [ 2,4,6,8,10,12,14,16,18,20,24 ],
    [ 3,6,9,12,15,18,21,24,27,30,33,36 ],
    [ 4,8,12,16,20,24,28,32,36,40,44,48 ],
    [ 5,10,15,20,25,30,35,40,45,50,55,60 ],
    [ 6,12,18,24,30,36,42,48,54,60,66,72 ],
    [ 7,14,21,28,35,42,49,56,63,70,77,84 ],
    [ 8,16,24,32,40,48,56,64,72,80,88,96 ],
    [ 9,18,27,36,45,54,63,72,81,90,99,108 ],
    [ 10,20,30,40,50,60,70,80,90,100,110,120 ],
    [ 11,22,33,44,55,66,77,88,99,110,121,132 ],
    [ 12,24,36,48,60,72,84,96,108,120,132,144 ]
    ]
    console.log("6 X 6 = ", timesTable[5][5])
    if (timesTable[5][5] == 36)
    {
        console.log("By golly they're equal.");
    }

	return timesTable
}

function wrapPlatform (platform) {
    // Half of platform width
    if (platform.y < 250)
    {
        platform.body.velocity.y = 100;
    }
    else if (platform.y > 450)
    {
        platform.body.velocity.y = -100;
    }
}

function wrapNumbers (number) {
    // Half of platform width
    if (number.x < -number.width)
    {
		number.body.position.x = (game.world.width - number.width) * 3.;
    }
}

function collectNumber (player, number) {

    // Removes the number from the screen
    //number.kill();

    //  Add and update the score
    answer = number.key;
	if (answer == solution)
	{
		/*
		var lefthand = game.rnd.integerInRange(1, 12);
		var righthand = game.rnd.integerInRange(1, 12);
		equation = lefthand.toString() + ' x ' + righthand.toString()
    	//equation = '4 x 4'

	    scoreText.text = equation + ' = '
	    scoreText.x = 400 - (scoreText.width / 2);
		solution = (timesTable[lefthand-1][righthand-1]).toString();

		number_sprites.destroy();
		*/
		number_sprites.removeAll();
		setupEquation();
	}
}

function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }
}

function setupEquation() {
	// Set up initial equation
    lefthand = game.rnd.integerInRange(1, 12);
    righthand = game.rnd.integerInRange(1, 12);
    solution = (timesTable[lefthand-1][righthand-1]).toString();
    console.log("Current solution is: ", solution);

	choice_array = [solution];
	for (var i = 0; i < 5; i++)
	{
		var choice = game.rnd.integerInRange(1, 144);
		choice_array.push(choice.toString());
	}
    shuffleArray(choice_array);

    //  The score
    equation = lefthand.toString() + ' x ' + righthand.toString()
	scoreText.text = equation + ' = '
	scoreText.x = (game.world.width / 2.) - (scoreText.width / 2.);
	solution = (timesTable[lefthand-1][righthand-1]).toString();


    // Numbers setup
	for (var i = 0; i < 6; i++)
	{
		var number_sprite = number_sprites.create(game.world.width + (i * game.world.width / 2), 125, choice_array[i]);
		number_sprite.scale.setTo(0.75, 0.75);
	    number_sprite.body.immovable = true;
	    number_sprite.body.allowGravity = false;
	}

    // Set numbers velocity
    number_sprites.setAll('body.velocity.x', -100);

}

</script>

</body>
</html>
